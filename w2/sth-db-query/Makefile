# Database Query Tool - Makefile
# ç”¨äºç®¡ç†é¡¹ç›®çš„æ„å»ºã€è¿è¡Œã€æµ‹è¯•å’Œç»´æŠ¤ä»»åŠ¡

.PHONY: help build up down restart logs clean test lint format db-init db-reset api-test frontend-dev backend-dev setup

# é»˜è®¤ç›®æ ‡
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Database Query Tool - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# === ç¯å¢ƒç®¡ç† ===

setup: ## åˆå§‹è®¾ç½®é¡¹ç›®ç¯å¢ƒ
	@echo "ğŸš€ è®¾ç½®é¡¹ç›®ç¯å¢ƒ..."
	cd backend && uv sync
	cd frontend && npm install
	@echo "âœ… é¡¹ç›®ç¯å¢ƒè®¾ç½®å®Œæˆ"

backend-setup: ## è®¾ç½®åç«¯ç¯å¢ƒ
	@echo "ğŸ”§ è®¾ç½®åç«¯ç¯å¢ƒ..."
	cd backend && uv sync
	@echo "âœ… åç«¯ç¯å¢ƒè®¾ç½®å®Œæˆ"

frontend-setup: ## è®¾ç½®å‰ç«¯ç¯å¢ƒ
	@echo "ğŸ¨ è®¾ç½®å‰ç«¯ç¯å¢ƒ..."
	cd frontend && npm install
	@echo "âœ… å‰ç«¯ç¯å¢ƒè®¾ç½®å®Œæˆ"

# === å¼€å‘æœåŠ¡å™¨ ===

dev: ## å¯åŠ¨æ‰€æœ‰å¼€å‘æœåŠ¡å™¨ (Docker Compose)
	@echo "ğŸš€ å¯åŠ¨æ‰€æœ‰å¼€å‘æœåŠ¡å™¨..."
	docker-compose up --build -d
	@echo "âœ… å¼€å‘æœåŠ¡å™¨å·²å¯åŠ¨"
	@echo "ğŸ“Š åç«¯API: http://localhost:8000"
	@echo "ğŸ¨ å‰ç«¯åº”ç”¨: http://localhost:5173"
	@echo "ğŸ“ APIæ–‡æ¡£: http://localhost:8000/docs"

dev-down: ## åœæ­¢æ‰€æœ‰å¼€å‘æœåŠ¡å™¨
	@echo "ğŸ›‘ åœæ­¢å¼€å‘æœåŠ¡å™¨..."
	docker-compose down
	@echo "âœ… å¼€å‘æœåŠ¡å™¨å·²åœæ­¢"

backend-dev: ## ä»…å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨
	@echo "ğŸ”§ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."
	cd backend && uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
	@echo "âœ… åç«¯æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:8000"

frontend-dev: ## ä»…å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
	@echo "ğŸ¨ å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
	cd frontend && npm run dev
	@echo "âœ… å‰ç«¯æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:5173"

# === æ•°æ®åº“ç®¡ç† ===

db-init: ## åˆå§‹åŒ–æ•°æ®åº“
	@echo "ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“..."
	cd backend && python init_db.py
	@echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"

db-reset: ## é‡ç½®æ•°æ®åº“ (åˆ é™¤å¹¶é‡æ–°åˆ›å»º)
	@echo "ğŸ”„ é‡ç½®æ•°æ®åº“..."
	rm -rf .db_query/
	mkdir -p .db_query
	cd backend && python init_db.py
	@echo "âœ… æ•°æ®åº“é‡ç½®å®Œæˆ"

# === æ„å»ºå’Œéƒ¨ç½² ===

build: ## æ„å»ºæ‰€æœ‰æœåŠ¡
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰æœåŠ¡..."
	docker-compose build
	@echo "âœ… æ„å»ºå®Œæˆ"

backend-build: ## æ„å»ºåç«¯
	@echo "ğŸ”¨ æ„å»ºåç«¯..."
	cd backend && uv build --wheel
	@echo "âœ… åç«¯æ„å»ºå®Œæˆ"

frontend-build: ## æ„å»ºå‰ç«¯
	@echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
	cd frontend && npm run build
	@echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

# === æµ‹è¯• ===

test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	cd backend && uv run pytest
	cd frontend && npm test
	@echo "âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ"

test-backend: ## è¿è¡Œåç«¯æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
	cd backend && uv run pytest -v --cov=app --cov-report=term-missing
	@echo "âœ… åç«¯æµ‹è¯•å®Œæˆ"

test-frontend: ## è¿è¡Œå‰ç«¯æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
	cd frontend && npm test -- --coverage
	@echo "âœ… å‰ç«¯æµ‹è¯•å®Œæˆ"

test-api: ## ä½¿ç”¨REST Clientæµ‹è¯•API
	@echo "ğŸ”— æµ‹è¯•APIç«¯ç‚¹..."
	@echo "è¯·åœ¨VSCodeä¸­æ‰“å¼€ fixtures/test.rest æ–‡ä»¶"
	@echo "ç„¶åä½¿ç”¨REST Clientæ‰©å±•æ‰§è¡Œæµ‹è¯•"
	code fixtures/test.rest

# === ä»£ç è´¨é‡ ===

lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	cd backend && uv run ruff check .
	cd frontend && npm run lint
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

format: ## æ ¼å¼åŒ–ä»£ç 
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	cd backend && uv run ruff format .
	cd frontend && npm run format
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

type-check: ## ç±»å‹æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œç±»å‹æ£€æŸ¥..."
	cd backend && uv run mypy app/
	cd frontend && npm run type-check
	@echo "âœ… ç±»å‹æ£€æŸ¥å®Œæˆ"

# === æ—¥å¿—å’Œç›‘æ§ ===

logs: ## æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
	@echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
	docker-compose logs -f

logs-backend: ## æŸ¥çœ‹åç«¯æ—¥å¿—
	@echo "ğŸ“‹ æŸ¥çœ‹åç«¯æ—¥å¿—..."
	docker-compose logs -f backend

logs-frontend: ## æŸ¥çœ‹å‰ç«¯æ—¥å¿—
	@echo "ğŸ“‹ æŸ¥çœ‹å‰ç«¯æ—¥å¿—..."
	docker-compose logs -f frontend

# === æ¸…ç† ===

clean: ## æ¸…ç†æ„å»ºäº§ç‰©å’Œç¼“å­˜
	@echo "ğŸ§¹ æ¸…ç†é¡¹ç›®..."
	# åœæ­¢å®¹å™¨
	docker-compose down -v 2>/dev/null || true
	# æ¸…ç†Pythonç¼“å­˜
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.pyc" -delete 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	# æ¸…ç†Nodeç¼“å­˜
	rm -rf frontend/node_modules/.cache 2>/dev/null || true
	rm -rf frontend/dist 2>/dev/null || true
	# æ¸…ç†æ„å»ºäº§ç‰©
	rm -rf backend/dist 2>/dev/null || true
	rm -rf backend/build 2>/dev/null || true
	@echo "âœ… é¡¹ç›®æ¸…ç†å®Œæˆ"

clean-all: clean ## æ·±åº¦æ¸…ç† (åŒ…æ‹¬ä¾èµ–)
	@echo "ğŸ§¹ æ·±åº¦æ¸…ç†é¡¹ç›®..."
	# æ¸…ç†Pythonè™šæ‹Ÿç¯å¢ƒ
	rm -rf backend/.venv 2>/dev/null || true
	rm -rf backend/uv.lock 2>/dev/null || true
	# æ¸…ç†Nodeä¾èµ–
	rm -rf frontend/node_modules 2>/dev/null || true
	rm -rf frontend/package-lock.json 2>/dev/null || true
	# æ¸…ç†æ•°æ®åº“
	rm -rf .db_query 2>/dev/null || true
	@echo "âœ… æ·±åº¦æ¸…ç†å®Œæˆ"

# === å¿«æ·å‘½ä»¤ ===

install: setup ## å®‰è£…æ‰€æœ‰ä¾èµ– (setupçš„åˆ«å)

run: dev ## è¿è¡Œé¡¹ç›® (devçš„åˆ«å)

stop: dev-down ## åœæ­¢é¡¹ç›® (dev-downçš„åˆ«å)

restart: ## é‡å¯æ‰€æœ‰æœåŠ¡
	@echo "ğŸ”„ é‡å¯æ‰€æœ‰æœåŠ¡..."
	docker-compose restart
	@echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"

status: ## æŸ¥çœ‹æœåŠ¡çŠ¶æ€
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	docker-compose ps

# === å¸®åŠ©ä¿¡æ¯ ===

info: ## æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
	@echo "ğŸ“‹ Database Query Tool - é¡¹ç›®ä¿¡æ¯"
	@echo "=================================="
	@echo "åç«¯æŠ€æœ¯æ ˆ: FastAPI, SQLAlchemy, Pydantic, SQLite"
	@echo "å‰ç«¯æŠ€æœ¯æ ˆ: React, Refine5, TypeScript, Tailwind CSS"
	@echo "æ•°æ®åº“: SQLite (æœ¬åœ°), PostgreSQL (æµ‹è¯•)"
	@echo "APIæ–‡æ¡£: http://localhost:8000/docs"
	@echo "å‰ç«¯åº”ç”¨: http://localhost:5173"
	@echo ""
	@echo "ä¸»è¦æ–‡ä»¶:"
	@echo "  - backend/pyproject.toml    - åç«¯ä¾èµ–é…ç½®"
	@echo "  - frontend/package.json     - å‰ç«¯ä¾èµ–é…ç½®"
	@echo "  - docker-compose.yml        - å¼€å‘ç¯å¢ƒé…ç½®"
	@echo "  - fixtures/test.rest        - APIæµ‹è¯•ç”¨ä¾‹"
	@echo "  - specs/                    - é¡¹ç›®è§„æ ¼æ–‡æ¡£"
